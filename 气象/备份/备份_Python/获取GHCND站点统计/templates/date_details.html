<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ t('details_page.title', station_name=station_name) }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .details-container {
            max-width: 1200px;
            margin: 20px auto;
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        h1 {
            font-size: 1.8rem;
            margin: 0;
            color: #333;
            text-align: left;
        }

        h2 {
            font-size: 1.2rem;
            margin: 10px 0 5px 0;
            color: #666;
            font-weight: normal;
        }

        h3 {
            margin-top: 5px;
            margin-bottom: 15px;
            color: #333;
            font-size: 1.1rem;
            border-bottom: none;
            font-weight: bold;
        }

        .header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
            padding-bottom: 10px;
            flex-wrap: wrap;
            /* responsive wrap */
            gap: 10px;
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .details-container {
                padding: 15px;
                margin: 10px;
                width: auto;
            }

            .header-row {
                flex-direction: column-reverse;
                align-items: flex-start;
            }

            #languageSelect {
                margin-bottom: 10px;
                align-self: flex-end;
            }

            .data-table th,
            .data-table td {
                padding: 8px 5px;
                font-size: 0.9rem;
            }

            h1 {
                font-size: 1.3rem;
            }

            h2 {
                font-size: 1rem;
            }
        }

        .back-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: bold;
        }

        .back-btn:hover {
            background-color: #5a6268;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0;
            color: #333;
        }

        h2 {
            font-size: 1.1rem;
            margin: 5px 0 0 0;
            color: #666;
            font-weight: normal;
        }

        .controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .copy-btn {
            background-color: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
        }

        .copy-btn:hover {
            background-color: #138496;
        }

        .period-highlight {
            color: #d32f2f;
            font-weight: 900;
            font-size: 1.1em;
        }

        .station-meta {
            margin-top: 5px;
            font-size: 0.95rem;
            color: #555;
        }

        .meta-item {
            display: inline-block;
            margin-right: 15px;
            padding: 4px 8px;
            background: white;
            border: 1px dashed #bbb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            color: #666;
        }

        .meta-item:hover {
            background: #f8f9fa;
            border-color: #333;
            color: #000;
        }

        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 4px;
            padding: 10px;
            position: fixed;
            z-index: 1000;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            font-size: 16px;
        }

        .toast.show {
            visibility: visible;
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        @keyframes fadein {
            from {
                bottom: 0;
                opacity: 0;
            }

            to {
                bottom: 30px;
                opacity: 1;
            }
        }

        @keyframes fadeout {
            from {
                bottom: 30px;
                opacity: 1;
            }

            to {
                bottom: 0;
                opacity: 0;
            }
        }
    </style>
</head>

<body>
    <div class="details-container">
        <div class="header-row">
            <div>
                <h1>{{ station_name }}</h1>

                {% if station_info and station_info.lat != '-' %}
                <div class="station-meta">
                    <span class="meta-item copyable" title="Click to copy Coordinates">{{ station_info.lat }}&#9;{{
                        station_info.lon }}</span>
                    <span class="meta-item copyable" title="Click to copy Elevation">{{ station_info.elev }}m</span>
                </div>
                {% endif %}

                {% if query_type == 'period' %}
                <div style="margin-top: 5px; margin-bottom: 20px;">
                    <p style="font-size: 1.1rem; color: #555;">
                        <strong>
                            {% if period_mode == 'p1' %}{{ t('season.winter') }}{% else %}{{ t('season.summer') }}{%
                            endif %}:
                        </strong>
                        {{ value }}
                    </p>
                </div>
                {% elif query_type == 'list' %}
                <h2>{{ t('details_page.info_' + query_type, value=value) if query_type else '' }}</h2>
                {% endif %}
                <h3 style="margin-top: 5px; color: #555; font-size: 1rem;">
                    {% if expected_total %}
                    {{ t('details_page.expected_total', count=records|length, expected=expected_total) }}
                    {% else %}
                    {{ t('details_page.total_records', count=records|length) }}
                    {% endif %}
                </h3>
            </div>
            <div>
                <select id="languageSelect" onchange="window.location.href='/set_language/' + this.value"
                    style="padding: 5px; border-radius: 4px; border: 1px solid #ccc;">
                    <option value="en" {% if lang()=='en' %}selected{% endif %}>English</option>
                    <option value="zh" {% if lang()=='zh' %}selected{% endif %}>中文</option>
                </select>
            </div>
        </div>

        {% if error_msg %}
        <div
            style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 4px; border: 1px solid #f5c6cb; margin-bottom: 20px; font-weight: bold; text-align: center;">
            {{ error_msg }}
        </div>
        {% endif %}

        {% if streaks and records|length > 10 %}
        <div class="collapsible-wrapper" id="streaksCollapsible">
            <div class="collapsible-header" onclick="toggleSection('streaksCollapsible')">
                <strong style="font-size: 1.1rem; color: #333;">{{ t('details_page.consecutive_days_title') }}</strong>
                <span class="collapsible-icon">▼</span>
            </div>
            <div class="collapsible-content">
                <div class="collapsible-inner">
                    <div style="display: flex; gap: 20px; margin-bottom: 0px; flex-wrap: wrap;">
                        {% for metric, list in streaks.items() %}
                        <div
                            style="flex: 1; min-width: 250px; background: #f9f9f9; padding: 10px; border-radius: 5px; border: 1px solid #eee;">
                            <h4
                                style="margin: 0 0 10px 0; font-size: 1rem; color: #333; border-bottom: 2px solid #ddd; padding-bottom: 5px;">
                                {% set symbol_map = {'lte': ' <= ', ' gte': ' >= ' } %} {{ t('metrics.' + metric|lower)
                                    }} {{ symbol_map[thresholds[metric]['dir']|trim] }} {{ thresholds[metric]['val'] }}
                                    {{ t('details_page.top_consecutive') }} </h4>
                                    {% if list %}
                                    <ol style="margin: 0; padding-left: 20px; font-size: 0.9rem;">
                                        {% for item in list %}
                                        <li style="margin-bottom: 4px;">{{ item }}</li>
                                        {% endfor %}
                                    </ol>
                                    {% else %}
                                    <p style="margin: 0; font-size: 0.9rem; color: #888;">{{
                                        t('details_page.no_streaks') }}</p>
                                    {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div style="margin-bottom: 20px;"></div>
        {% endif %}

        <div class="controls"
            style="display: flex; flex-direction: column; align-items: flex-end; gap: 10px; margin-bottom: 10px;">
            {% if query_type == 'period' %}
            {% set default_date = value.split('-')[0] + '-07-16' if period_mode == 'p1' else value.split('-')[0] +
            '-01-16' %}
            <div style="display: flex; align-items: center; gap: 10px;">
                <label for="startDateInput" style="font-weight:bold; color:#555;">{{
                    t('details_page.starting_date_label') }}:</label>
                <input type="text" id="startDateInput" placeholder="{{ t('details_page.starting_date_placeholder') }}"
                    maxlength="10" style="padding:6px; border-radius:4px; border:1px solid #ccc; width: 120px;"
                    oninput="handleStartingDateInput()" value="{{ default_date }}">
                <button onclick="handleStartingDateInput()"
                    style="padding: 6px 12px; cursor: pointer; border-radius: 4px; border: 1px solid #ccc; background-color: #f8f9fa;">{{
                    t('params.go') }}</button>
            </div>

            <div style="display: flex; align-items: center; gap: 5px;">
                <label for="monthFilter" style="font-weight:bold; color:#555; white-space: nowrap;">{{
                    t('details_page.range_filter_title') }}</label>
                <select id="monthFilter" onchange="applyFilters()"
                    style="padding:6px; border-radius:4px; border:1px solid #ccc;">
                    <option value="all">{{ t('months.full_year') }}</option>
                    {% if period_mode == 'p1' %}
                    <option value="winter_3">{{ t('months.winter_3') }}</option>
                    {% elif period_mode == 'p2' %}
                    <option value="summer_3">{{ t('months.summer_3') }}</option>
                    {% endif %}
                    <option value="01">{{ t('months.january') }}</option>
                    <option value="02">{{ t('months.february') }}</option>
                    <option value="03">{{ t('months.march') }}</option>
                    <option value="04">{{ t('months.april') }}</option>
                    <option value="05">{{ t('months.may') }}</option>
                    <option value="06">{{ t('months.june') }}</option>
                    <option value="07">{{ t('months.july') }}</option>
                    <option value="08">{{ t('months.august') }}</option>
                    <option value="09">{{ t('months.september') }}</option>
                    <option value="10">{{ t('months.october') }}</option>
                    <option value="11">{{ t('months.november') }}</option>
                    <option value="12">{{ t('months.december') }}</option>
                </select>
            </div>
            {% endif %}
        </div>

        {% if query_type == 'period' %}
        <div id="filteredStatsContainer" style="margin-bottom: 25px;">
            <h3>{{ t('details_page.filtered_stats_title') }}</h3>
            <div class="table-responsive">
                <table class="stats-table" id="filteredStatsTable">
                    <thead>
                        <tr>
                            <th>{{ t('tables.type') }}</th>
                            <th>{{ t('details_page.stat_min') }}(℃)</th>
                            <th>{{ t('details_page.stat_avg') }}(℃)</th>
                            <th>{{ t('details_page.stat_max') }}(℃)</th>
                            <th>{{ t('details_page.stat_valid_days') }}</th>
                            <th>{{ t('details_page.stat_expected_days') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-element="TMIN">
                            <td><strong>{{ t('metrics.tmin') }}</strong></td>
                            <td class="stat-min">-</td>
                            <td class="stat-avg">-</td>
                            <td class="stat-max">-</td>
                            <td class="stat-valid">-</td>
                            <td class="stat-expected">-</td>
                        </tr>
                        <tr data-element="TAVG">
                            <td><strong>{{ t('metrics.tavg') }}</strong></td>
                            <td class="stat-min">-</td>
                            <td class="stat-avg">-</td>
                            <td class="stat-max">-</td>
                            <td class="stat-valid">-</td>
                            <td class="stat-expected">-</td>
                        </tr>
                        <tr data-element="TMAX">
                            <td><strong>{{ t('metrics.tmax') }}</strong></td>
                            <td class="stat-min">-</td>
                            <td class="stat-avg">-</td>
                            <td class="stat-max">-</td>
                            <td class="stat-valid">-</td>
                            <td class="stat-expected">-</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <div style="margin-bottom: 15px; text-align: right;">
            <button class="copy-btn" onclick="copyTable()" style="padding: 10px 20px; font-size: 1rem;">{{
                t('details_page.copy_tsv') }}</button>
        </div>

        <div class="table-responsive" style="max-height: none;">
            <table class="data-table" id="detailsTable">
                <thead>
                    <tr>
                        <th onclick="sortTable('date')">{{ t('details_page.header_date') }} &#8593;&#8595;</th>
                        <th onclick="sortTable('tmin')">{{ t('details_page.header_tmin') }} &#8593;&#8595;</th>
                        <th onclick="sortTable('tavg')">{{ t('details_page.header_tavg') }} &#8593;&#8595;</th>
                        <th onclick="sortTable('tmax')">{{ t('details_page.header_tmax') }} &#8593;&#8595;</th>
                    </tr>
                </thead>
                <tbody>
                    {% if records %}
                    {% for row in records %}
                    <tr>
                        <td>{{ row.DATE }}</td>
                        <td{{ ' class="copy-cell"' |safe if row.TMIN is not none and row.TMIN==row.TMIN and row.TMIN
                            !='-' else '' }}>{{ row.TMIN if row.TMIN is not none and row.TMIN == row.TMIN else '-' }}
                            </td>
                            <td{{ ' class="copy-cell"' |safe if row.TAVG is not none and row.TAVG==row.TAVG and row.TAVG
                                !='-' else '' }}>{{ row.TAVG if row.TAVG is not none and row.TAVG == row.TAVG else '-'
                                }}</td>
                                <td{{ ' class="copy-cell"' |safe if row.TMAX is not none and row.TMAX==row.TMAX and
                                    row.TMAX !='-' else '' }}>{{ row.TMAX if row.TMAX is not none and row.TMAX ==
                                    row.TMAX else '-' }}</td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="4" style="text-align:center;">{{ t('details_page.no_records') }}</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>

    <div id="copyToast">{{ t('messages.copied_to_clipboard') }}</div>

    <script>
        let sortCol = 'date';
        let sortDir = 'asc';

        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('active');
            }
        }

        function handleStartingDateInput() {
            const val = document.getElementById('startDateInput').value;
            // Strict regex for YYYY-MM-DD
            const regex = /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12][0-9]|3[01])$/;
            if (val.length === 10) {
                if (regex.test(val)) {
                    reorderTable(val);
                } else {
                    showToast("{{ t('details_page.invalid_format_warning') }}");
                }
            }
        }

        function reorderTable(startDate) {
            const table = document.getElementById("detailsTable");
            const tbody = table.querySelector('tbody');
            let allRows = Array.from(tbody.querySelectorAll('tr'));
            if (allRows.length <= 1) return;

            // Sort chronologically first to ensure stable base order
            allRows.sort((a, b) => {
                let valA = a.cells[0].innerText.trim();
                let valB = b.cells[0].innerText.trim();
                return valA.localeCompare(valB);
            });

            // If a filter is active, we should only work with visible rows?
            // User said: "once I input a valid date string... it will set the inputed date as the first row... which completed a closed cycle through the current date range."
            // This implies the full set should be ordered, but if filtered, maybe just the visible ones?
            // Let's reorder all rows, then filtering will apply visibility.

            let startIndex = allRows.findIndex(r => r.cells[0].innerText.trim() === startDate);

            if (startIndex === -1) {
                let msg = "{{ t('details_page.date_not_found', date='___DATE___') }}".replace('___DATE___', startDate);
                showToast(msg);
                return;
            }

            const reordered = [
                ...allRows.slice(startIndex),
                ...allRows.slice(0, startIndex)
            ];

            tbody.innerHTML = '';
            reordered.forEach(r => tbody.appendChild(r));
        }

        function applyFilters() {
            const monthVal = document.getElementById('monthFilter').value;
            const table = document.getElementById('detailsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            // Default sort by date ASC when range is selected
            rows.sort((a, b) => {
                let valA = a.cells[0].innerText.trim();
                let valB = b.cells[0].innerText.trim();
                return valA.localeCompare(valB);
            });

            rows.forEach(row => {
                const dateText = row.cells[0].innerText.trim();
                const month = dateText.split('-')[1]; // YYYY-MM-DD -> MM

                let show = false;
                if (monthVal === 'all') {
                    show = true;
                } else if (monthVal === 'winter_3') {
                    show = ['12', '01', '02'].includes(month);
                } else if (monthVal === 'summer_3') {
                    show = ['06', '07', '08'].includes(month);
                } else {
                    show = (month === monthVal);
                }

                row.style.display = show ? '' : 'none';
            });

            // Re-append rows in sorted order
            tbody.innerHTML = '';
            rows.forEach(r => tbody.appendChild(r));

            // Note: If start date reordering was active, it gets reset by chronological sort here.
            // This matches "sorted by date asc in default" requirement when range is selected.

            if (document.getElementById('filteredStatsTable')) {
                updateFilteredStats(rows, monthVal);
            }
        }

        function updateFilteredStats(allRows, monthVal) {
            const table = document.getElementById('filteredStatsTable');
            const metrics = ['TMIN', 'TAVG', 'TMAX'];

            // 1. Calculate Expected Days
            const periodValue = "{{ value }}"; // e.g. "1987-1988"
            const periodMode = "{{ period_mode }}"; // "p1" or "p2"
            let expectedCount = 0;
            try {
                const year1 = parseInt(periodValue.split('-')[0]);
                const year2 = parseInt(periodValue.split('-')[1]);
                let startDt, endDt;
                if (periodMode === 'p1') {
                    startDt = new Date(year1, 6, 16); // Month is 0-indexed, so 6 is July
                    endDt = new Date(year2, 6, 15);
                } else {
                    startDt = new Date(year1, 0, 16);
                    endDt = new Date(year2, 0, 15);
                }

                for (let d = new Date(startDt); d <= endDt; d.setDate(d.getDate() + 1)) {
                    const m = (d.getMonth() + 1).toString().padStart(2, '0');
                    let match = false;
                    if (monthVal === 'all') match = true;
                    else if (monthVal === 'winter_3') match = ['12', '01', '02'].includes(m);
                    else if (monthVal === 'summer_3') match = ['06', '07', '08'].includes(m);
                    else match = (m === monthVal);
                    if (match) expectedCount++;
                }
            } catch (e) { console.error("Error calculating expected days", e); }

            // 2. Loop through metrics
            metrics.forEach((mName, idx) => {
                const row = table.querySelector(`tr[data-element="${mName}"]`);
                const cellIdx = idx + 1; // TMIN=1, TAVG=2, TMAX=3 in table rows

                let vals = [];
                allRows.forEach(r => {
                    if (r.style.display === 'none') return;
                    const txt = r.cells[cellIdx].innerText.trim();
                    if (txt !== '-' && !isNaN(txt)) {
                        vals.push(parseFloat(txt));
                    }
                });

                if (vals.length > 0) {
                    const min = Math.min(...vals);
                    const max = Math.max(...vals);
                    const avg = (vals.reduce((a, b) => a + b, 0) / vals.length).toFixed(2);

                    row.querySelector('.stat-min').innerText = min;
                    row.querySelector('.stat-avg').innerText = avg;
                    row.querySelector('.stat-max').innerText = max;
                    row.querySelector('.stat-valid').innerText = vals.length;
                    row.querySelector('.stat-expected').innerText = expectedCount;
                } else {
                    row.querySelector('.stat-min').innerText = '-';
                    row.querySelector('.stat-avg').innerText = '-';
                    row.querySelector('.stat-max').innerText = '-';
                    row.querySelector('.stat-valid').innerText = 0;
                    row.querySelector('.stat-expected').innerText = expectedCount;
                }
            });
        }

        // Call applyFilters on load if period mode to show stats for "All"
        window.addEventListener('DOMContentLoaded', () => {
            if ("{{ query_type }}" === "period") {
                applyFilters();
            }
        });

        function sortTable(column) {
            const table = document.getElementById('detailsTable');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            if (sortCol === column) { sortDir = (sortDir === 'asc') ? 'desc' : 'asc'; }
            else { sortCol = column; sortDir = 'asc'; }

            const getVal = (row, idx) => {
                const txt = row.children[idx].innerText.trim();
                if (txt === '-') return -9999;
                return isNaN(txt) ? txt : parseFloat(txt);
            };

            const colIdxMap = { 'date': 0, 'tmin': 1, 'tavg': 2, 'tmax': 3 };
            const idx = colIdxMap[column];

            rows.sort((a, b) => {
                const valA = getVal(a, idx);
                const valB = getVal(b, idx);

                // Treats -9999 as our "empty" marker from getVal above. 
                // Wait, getVal logic was: if (txt === '-') return -9999;
                // This forces it to be a small number. We need to Change getVal too or handle -9999 here.

                // Let's modify getVal return to be 'raw' if we want clean logic, or handle -9999 as the "empty" sentinal.
                // But -9999 is a valid temperature sometimes? Unlikely for Earth, but possible in data errors.
                // Better to return null for empty.

                let isEmptyA = (valA === -9999);
                let isEmptyB = (valB === -9999);

                if (isEmptyA && isEmptyB) return 0;
                if (isEmptyA) return 1;
                if (isEmptyB) return -1;

                if (valA < valB) return sortDir === 'asc' ? -1 : 1;
                if (valA > valB) return sortDir === 'asc' ? 1 : -1;
                return 0;
            });

            tbody.innerHTML = '';
            rows.forEach(r => tbody.appendChild(r));
        }

        function showToast(message) {
            const toast = document.getElementById('copyToast');
            toast.textContent = message;
            toast.className = 'show';
            setTimeout(() => toast.className = '', 3000);
        }

        function copyTable() {
            const table = document.getElementById('detailsTable');
            let tsv = '';

            // Get headers
            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => th.innerText.replace(' \u21c5', '').trim());
            tsv += headers.join('\t') + '\n';

            // Get visible rows
            const rows = Array.from(table.querySelectorAll('tbody tr'))
                .filter(tr => tr.style.display !== 'none');

            rows.forEach(tr => {
                const cells = Array.from(tr.querySelectorAll('td'))
                    .map(td => td.innerText.trim());
                tsv += cells.join('\t') + '\n';
            });

            navigator.clipboard.writeText(tsv).then(() => {
                showToast("{{ t('details_page.copy_success') }}");
            });
        }

        // Global Copy Listener for .copyable items (Lat/Lon/Elev)
        document.addEventListener('click', function (e) {
            const target = e.target.closest('.copyable');
            if (target) {
                const text = target.innerText.trim();
                navigator.clipboard.writeText(text).then(() => {
                    showToast("{{ t('messages.copied_to_clipboard') }}");
                }).catch(err => { console.error('Failed to copy', err); });
            }
        });

        // Global Cell Copy (Target .copy-cell)
        document.addEventListener('click', function (e) {
            const targetCell = e.target.closest('.copy-cell');
            if (targetCell && !e.target.closest('button') && !e.target.closest('a')) {
                if (window.getSelection().toString().length > 0) return;
                const text = targetCell.innerText.trim();
                if (text && text !== '-') {
                    navigator.clipboard.writeText(text).then(() => { showToast(`Copied: ${text}`); })
                        .catch(err => { console.error('Failed to copy', err); });
                }
            }
        });
    </script>
</body>

</html>