<!DOCTYPE html>
<html lang="{{ lang() }}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ station_name }} - {{ t('links.view_year_stats') }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .month-section {
            margin-bottom: 40px;
        }

        .month-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            font-size: 1.25em;
            border-left: 5px solid #007bff;
            margin-bottom: 15px;
            color: #333;
        }

        /* Uses style.css for tooltip-container and tooltip-note */

        .station-meta-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        .meta-card {
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 8px 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            cursor: pointer;
            user-select: none;
        }

        .meta-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            border-color: #007bff;
        }

        .meta-card:active {
            transform: translateY(0);
        }

        .meta-icon {
            color: #6c757d;
            font-size: 1.1em;
        }

        .meta-label {
            font-size: 0.85em;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 5px;
            font-weight: 600;
        }

        .meta-value {
            font-weight: 500;
            color: #212529;
            font-family: Consolas, Monaco, 'Courier New', monospace;
        }

        .copy-hint {
            font-size: 0.75em;
            color: #adb5bd;
            margin-left: 5px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .meta-card:hover .copy-hint {
            opacity: 1;
        }
    </style>
</head>

<body>
    <div class="nav-bar" style="margin: 0 10px 20px 10px;">
        <div class="nav-left">
            <select id="languageSelect" onchange="window.location.href='/set_language/' + this.value"
                style="width: auto; padding: 5px;">
                <option value="en" {% if lang()=='en' %}selected{% endif %}>English</option>
                <option value="zh" {% if lang()=='zh' %}selected{% endif %}>中文</option>
            </select>
        </div>
    </div>
    <div class="container">
        <h1>{{ station_name }}</h1>
        <div class="station-meta-container">
            <!-- Coordinates -->
            <div class="meta-card" onclick="copyText('{{ station_info.lat }}\t{{ station_info.lon }}', this)"
                title="Click to copy coordinates">
                <span class="meta-label">Coords</span>
                <span class="meta-value">{{ station_info.lat }}, {{ station_info.lon }}</span>
                <span class="copy-hint">Copy</span>
            </div>

            <!-- Elevation -->
            <div class="meta-card" onclick="copyText('{{ station_info.elev }}', this)" title="Click to copy elevation">
                <span class="meta-label">Elev</span>
                <span class="meta-value">{{ station_info.elev }}m</span>
                <span class="copy-hint">Copy</span>
            </div>
        </div>

        {% if error_msg %}
        <div class="error">{{ error_msg }}</div>
        {% endif %}

        {% if error_msg %}
        <div class="error">{{ error_msg }}</div>
        {% endif %}

        <!-- Sorting Controls -->
        <div class="section"
            style="padding: 15px; margin-bottom: 25px; background: #f1f3f5; border: 1px solid #ced4da;">
            <h3 style="margin-top: 0; margin-bottom: 15px; font-size: 1.1em; border-bottom: none;">{{ t('sorting.title')
                }}</h3>
            <form action="{{ url_for('year_stats') }}" method="get" class="control-group"
                style="gap: 15px; align-items: flex-end;">
                <!-- Preserve existing params -->
                <input type="hidden" name="station_id" value="{{ request.args.get('station_id', '') }}">
                <input type="hidden" name="source" value="{{ request.args.get('source', '') }}">
                <input type="hidden" name="start_date" value="{{ request.args.get('start_date', '') }}">
                <input type="hidden" name="end_date" value="{{ request.args.get('end_date', '') }}">
                <input type="hidden" name="tmin_val" value="{{ request.args.get('tmin_val', '') }}">
                <input type="hidden" name="tmin_dir" value="{{ request.args.get('tmin_dir', '') }}">
                <input type="hidden" name="tavg_val" value="{{ request.args.get('tavg_val', '') }}">
                <input type="hidden" name="tavg_dir" value="{{ request.args.get('tavg_dir', '') }}">
                <input type="hidden" name="tmax_val" value="{{ request.args.get('tmax_val', '') }}">
                <input type="hidden" name="tmax_dir" value="{{ request.args.get('tmax_dir', '') }}">
                <input type="hidden" name="custom_avg_tmin" value="{{ request.args.get('custom_avg_tmin', '') }}">
                <input type="hidden" name="custom_avg_tavg" value="{{ request.args.get('custom_avg_tavg', '') }}">
                <input type="hidden" name="custom_avg_tmax" value="{{ request.args.get('custom_avg_tmax', '') }}">

                <!-- Row Select -->
                <div style="display: flex; flex-direction: column;">
                    <label for="sortRow" style="font-size: 0.9em; margin-bottom: 5px; font-weight: bold;">{{
                        t('sorting.row_label') }}</label>
                    <select id="sortRow" name="sort_row"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ced4da;">
                        <option value="TAVG" {% if request.args.get('sort_row')=='TAVG' %}selected{% endif %}>TAVG ({{
                            t('statistics.label_tavg_min') }})</option>
                        <option value="TMIN" {% if request.args.get('sort_row')=='TMIN' %}selected{% endif %}>TMIN ({{
                            t('statistics.label_tmin_min') }})</option>
                        <option value="TMAX" {% if request.args.get('sort_row')=='TMAX' %}selected{% endif %}>TMAX ({{
                            t('statistics.label_tmax_min') }})</option>
                    </select>
                </div>

                <!-- Column Select -->
                <div style="display: flex; flex-direction: column;">
                    <label for="sortCol" style="font-size: 0.9em; margin-bottom: 5px; font-weight: bold;">{{
                        t('sorting.col_label') }}</label>
                    <select id="sortCol" name="sort_col"
                        style="padding: 5px; border-radius: 4px; border: 1px solid #ced4da;">
                        <option value="avg" {% if request.args.get('sort_col')=='avg' %}selected{% endif %}>{{
                            t('tables.avg_c') }}</option>
                        <option value="min" {% if request.args.get('sort_col')=='min' %}selected{% endif %}>{{
                            t('tables.min_c') }}</option>
                        <option value="max" {% if request.args.get('sort_col')=='max' %}selected{% endif %}>{{
                            t('tables.max_c') }}</option>
                        <option value="explosive_power" {% if request.args.get('sort_col')=='explosive_power'
                            %}selected{% endif %}>{{ t('tables.explosive_power') }}</option>
                        <option value="count_match" {% if request.args.get('sort_col')=='count_match' %}selected{% endif
                            %}>{{ t('tables.days_matching_threshold') }}</option>
                        <option value="total_valid" {% if request.args.get('sort_col')=='total_valid' %}selected{% endif
                            %}>{{ t('tables.total_valid') }}</option>
                    </select>
                </div>

                <!-- Order Radio -->
                <div style="display: flex; flex-direction: column;">
                    <label style="font-size: 0.9em; margin-bottom: 5px; font-weight: bold;">{{ t('sorting.order_label')
                        }}</label>
                    <div class="radio-group" style="gap: 15px;">
                        <label style="font-weight: normal; font-size: 0.95em;">
                            <input type="radio" name="sort_order" value="asc" {% if request.args.get('sort_order', 'asc'
                                )=='asc' %}checked{% endif %}> {{ t('sorting.asc') }}
                        </label>
                        <label style="font-weight: normal; font-size: 0.95em;">
                            <input type="radio" name="sort_order" value="desc" {% if
                                request.args.get('sort_order')=='desc' %}checked{% endif %}> {{ t('sorting.desc') }}
                        </label>
                    </div>
                </div>

                <!-- Submit -->
                <button type="submit" class="submit-btn"
                    style="width: auto; padding: 8px 20px; font-size: 1rem; align-self: flex-end;">{{
                    t('sorting.submit') }}</button>
            </form>
        </div>

        {% for result in tables %}
        <div class="month-section">
            <h2 class="month-header">{{ result.month_name }}</h2>
            <div class="table-responsive">
                <table class="stats-table">
                    <thead>
                        <tr>
                            <th>{{ t('tables.type') }}</th>
                            <th>{{ t('tables.min_c') }}</th>
                            <th>{{ t('tables.avg_c') }}</th>
                            <th>{{ t('tables.max_c') }}</th>
                            <th>{{ t('tables.explosive_power') }}</th>
                            <th>{{ t('tables.days_matching_threshold') }}</th>
                            <th>{{ t('tables.total_valid') }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for elem in ['TMIN', 'TAVG', 'TMAX'] %}
                        {% set s = result.stats[elem] %}
                        {% set label_key = 'statistics.label_' + elem|lower + '_min' %}
                        <tr>
                            <td><strong>{{ t(label_key) }}</strong></td>

                            <!-- MIN -->
                            <td>
                                {% if s.min.val != '-' and s.min.dates %}
                                <div class="tooltip-container">
                                    <span>{{ s.min.val }}</span>
                                    <span class="tooltip-note clickable-date"
                                        onclick="event.stopPropagation(); openDateDetails('list', '{{ s.min.dates|join(',') }}')">{{
                                        s.min.dates[:20]|join('\n') }}{% if s.min.dates|length > 20 %}{{
                                        '\n...and ' ~ (s.min.dates|length - 20) ~ ' more' }}{% endif %}</span>
                                </div>
                                {% else %}
                                {{ s.min.val }}
                                {% endif %}
                            </td>

                            <!-- AVG -->
                            <td>{{ s.avg }}</td>

                            <!-- MAX -->
                            <td>
                                {% if s.max.val != '-' and s.max.dates %}
                                <div class="tooltip-container">
                                    <span>{{ s.max.val }}</span>
                                    <span class="tooltip-note clickable-date"
                                        onclick="event.stopPropagation(); openDateDetails('list', '{{ s.max.dates|join(',') }}')">{{
                                        s.max.dates[:20]|join('\n') }}{% if s.max.dates|length > 20 %}{{
                                        '\n...and ' ~ (s.max.dates|length - 20) ~ ' more' }}{% endif %}</span>
                                </div>
                                {% else %}
                                {{ s.max.val }}
                                {% endif %}
                            </td>

                            <!-- Power -->
                            <td>{{ s.explosive_power }}</td>

                            <!-- Count Match -->
                            <td>{{ s.count_match }}</td>

                            <!-- Total -->
                            <td>{{ s.total_valid }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endfor %}

        <div style="text-align: center; margin-top: 30px; margin-bottom: 50px;">
        </div>

    </div>
    <script>
        function openDateDetails(mode, value) {
            // mode is usually 'list' here
            // Get current params from URL
            const params = new URLSearchParams(window.location.search);

            // Construct new URL for date_details
            let url = `/date_details?type=${mode}&value=${encodeURIComponent(value)}`;

            // Pass through other important params
            if (params.has('station_id')) url += `&station_id=${params.get('station_id')}`;
            if (params.has('source')) url += `&source=${params.get('source')}`;

            // Pass thresholds (needed for streak calculation if any, though less relevant for 'list' type but good consistency)
            if (params.has('tmin_val')) url += `&tmin_val=${params.get('tmin_val')}`;
            if (params.has('tmin_dir')) url += `&tmin_dir=${params.get('tmin_dir')}`;
            if (params.has('tavg_val')) url += `&tavg_val=${params.get('tavg_val')}`;
            if (params.has('tavg_dir')) url += `&tavg_dir=${params.get('tavg_dir')}`;
            if (params.has('tmax_val')) url += `&tmax_val=${params.get('tmax_val')}`;
            if (params.has('tmax_dir')) url += `&tmax_dir=${params.get('tmax_dir')}`;

            window.open(url, '_blank');
        }
        function copyText(text, el) {
            // If el is not provided, or if text is an element (old usage), handle gracefully (though we updated usages)
            if (typeof text !== 'string') {
                text = text.innerText;
                el = text;
            }

            navigator.clipboard.writeText(text).then(() => {
                // Visual feedback
                if (el) {
                    const originalBg = getComputedStyle(el).backgroundColor;
                    const originalBorder = getComputedStyle(el).borderColor;

                    el.style.backgroundColor = '#d4edda';
                    el.style.borderColor = '#c3e6cb';

                    setTimeout(() => {
                        el.style.backgroundColor = '';
                        el.style.borderColor = '';
                    }, 400);
                }
            });
        }
    </script>
</body>

</html>